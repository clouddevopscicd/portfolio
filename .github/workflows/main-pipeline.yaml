docker-build-scan:
  name: Build Docker Image, Scan with Trivy, Push to Registry
  runs-on: ubuntu-latest
  needs: sonarcloud-analysis

  steps:
    - uses: actions/checkout@v4

    - name: Verify Docker and Install Trivy
      run: |
        set -e
        docker --version
        sudo systemctl start docker || true
        wget https://github.com/aquasecurity/trivy/releases/download/v0.63.0/trivy_0.63.0_Linux-64bit.tar.gz
        tar zxvf trivy_0.63.0_Linux-64bit.tar.gz
        sudo mv trivy /usr/local/bin/
        trivy --version

    - name: Setup Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Docker Login
      uses: docker/login-action@v2
      with:
        username: ${{ vars.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Build Docker Image
      run: |
        set -e
        docker build -t $REGISTRY/$IMAGE_NAME:${{ github.sha }} .

    - name: Trivy Scan
      run: |
        set -e
        trivy image --severity CRITICAL,HIGH --exit-code 0 -f json -o trivy-report.json $REGISTRY/$IMAGE_NAME:${{ github.sha }}

    - name: Upload Trivy Report
      uses: actions/upload-artifact@v4
      with:
        name: trivy-report
        path: trivy-report.json

    - name: Push Docker Image
      run: |
        docker push $REGISTRY/$IMAGE_NAME:${{ github.sha }}
